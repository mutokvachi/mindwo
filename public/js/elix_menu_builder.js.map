{"version":3,"sources":["menu_builder.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"elix_menu_builder.js","sourcesContent":["(function($)\n{\n\t/**\n\t * MenuBuilder - a jQuery plugin that renders menu drag & drop building UI\n\t *\n\t * @param root\n\t * @returns {*}\n\t * @constructor\n\t */\n\t$.fn.MenuBuilder = function(opts)\n\t{\n\t\tvar options = $.extend({}, $.fn.MenuBuilder.defaults, opts);\n\t\treturn this.each(function()\n\t\t{\n\t\t\tnew $.MenuBuilder(this, options);\n\t\t});\n\t};\n\t\n\t$.fn.MenuBuilder.defaults = {\n            root_url: getBaseUrl(),\n            builder_url: \"constructor/menu/\",\n            menu_list_id: 5\n\t};\n\t\n\t/**\n\t * MenuBuilder constructor\n\t *\n\t * @param root\n\t * @constructor\n\t */\n\t$.MenuBuilder = function(root, opts)\n\t{\n            $.data(root, 'MenuBuilder', this);\n            var self = this;\n            this.options = opts;\n            this.root = $(root);\n            this.nodes = null;\n            this.root_url = getBaseUrl();\n            this.site_id = self.root.find(\".dx-sites-cbo\").val();\n            this.itm_to_edit = null;\n            \n            var saveData = function(onsaved) {\n                show_page_splash();\n                var request = {\n                        site_id: self.site_id,\n                        items: self.nodes,\n                        _method: 'put'\n                };\n                \n                var save_url = self.options.root_url + self.options.builder_url + self.site_id;\n                \n                $.ajax({\n                        type: 'post',\n                        url: save_url,\n                        dataType: 'json',\n                        data: request,\n                        success: function(data)\n                        {\n                            self.nodes = null\n                            $(\".dx-stick-footer\").removeClass('dx-page-in-edit-mode');\n                            \n                            if (onsaved) {\n                                onsaved.call(this);\n                            }\n                            else {\n                                show_page_splash();\n                                notify_info(Lang.get('constructor.menu.msg_saved'));\n                                setTimeout(function(){ window.location.reload(true); }, 1000);\n                            }\n                        }\n                });  \n            };\n            \n            var validateChilds = function() {\n                if ($(\".dx-menu-builder\").find(\".parentError\").length !== 0) {\n                    notify_err(Lang.get('constructor.menu.err_parent'));\n                    $('html, body').animate({\n                        scrollTop: $(\".dx-menu-builder\").find(\".parentError:last\").offset().top - 66\n                    }, 2000);\n                    return false;\n                }\n                \n                return true;\n            };\n            \n            var editItemOpen = function () {\n                var itm = self.itm_to_edit;\n                show_page_splash();\n                open_form('form', itm.attr(\"data-id\"), self.options.menu_list_id, 0, 0, \"\", 0, \"\", {\n                    after_close: function(frm)\n                    {\n                        var new_parent_id = frm.find(\"[name=parent_id]\").val();\n                        var new_order = frm.find(\"[name=order_index]\").val();\n                        \n                        if (new_parent_id !== itm.attr(\"data-parent-id\") || new_order !== itm.attr(\"data-order-index\")) {\n                            show_page_splash();\n                            window.location.reload();\n                            return;\n                        }\n                        \n                        var new_title = frm.find(\"[name=title]\").val();\n                        var new_icon = frm.find(\"[name=fa_icon]\").val();\n                        \n                        if (itm.attr(\"data-title\") !== new_title) {\n                            itm.attr(\"data-title\", new_title);                            \n                            itm.find(\".dx-title:first\").text(new_title);\n                        }\n                        \n                        if (itm.attr(\"data-icon\") !== new_icon) {\n                            itm.find(\".dx-icon:first\").removeClass().addClass(new_icon).addClass(\"dx-icon\");\n                            itm.attr(\"data-icon\", new_icon);\n                        } \n                        \n                        var new_color = frm.find(\"[name=color]\").val();\n                        if (itm.attr(\"data-color\") !== new_color) {\n                            itm.find(\".dx-icon:first\").css(\"color\", new_color);\n                            itm.find(\".dx-title:first\").css(\"color\", new_color);\n                            itm.attr(\"data-color\", new_color);\n                        }\n                        self.itm_to_edit = null;\n                    }\n                });\n            }\n            \n            var newItemOpen = function() {\n                open_form('form', 0, self.options.menu_list_id, 0, 0, \"\", 1, \"\", {\n                    after_close: function(frm)\n                    {\n                        var new_id = parseInt(frm.find(\"[name=item_id]\").val());\n                       if (new_id > 0 ) {\n                            show_page_splash();\n                            window.location.reload();\n                        }\n                    }\n                });\n            };\n            \n            var undo_changes = function() {\n                show_page_splash();\n                $(\".dx-stick-footer\").removeClass('dx-page-in-edit-mode');\n                window.location.reload();\n            };\n            \n            this.root.find(\".dx-undo-btn\").click(function() {\n                PageMain.showConfirm(undo_changes, null, Lang.get('constructor.menu.confirm_title'), Lang.get('constructor.menu.confirm_msg'), Lang.get('constructor.menu.confirm_yes'), Lang.get('constructor.menu.confirm_no'), null);\n            });\n            \n            this.root.find(\".dx-new-btn\").click(function() {\n                if (self.nodes) {\n                    if (!validateChilds()) {                        \n                        return false;\n                    }\n                \n                    saveData(newItemOpen);\n                    return;\n                }\n                \n                newItemOpen();\n            });\n            \n            this.root.find(\".dx-edit-menu-link\").click(function() {\n                self.itm_to_edit = $(this).closest(\".dd-item\");\n                \n                if (self.nodes) {\n                    if (!validateChilds()) {\n                        self.itm_to_edit = null;\n                        return false;\n                    }\n                \n                    saveData(editItemOpen);\n                    return;\n                }\n                \n                editItemOpen();\n            });\n            \n            this.root.find(\".dx-save-btn\").click(function() {\n                if (!self.nodes) {\n                    notify_err(Lang.get('constructor.menu.err_no_changes'));\n                    return false;\n                }\n                \n                if (!validateChilds()) {\n                    return false;\n                }\n                saveData();\n            });\n            \n            var updateOutput = function (e) {\n                var list = e.length ? e : $(e.target);\n                if (window.JSON) {\n                    self.nodes = window.JSON.stringify(list.nestable('serialize'));                    \n                    $('.dx-stick-footer').addClass('dx-page-in-edit-mode');\n                    self.root.find(\".dx-undo-btn\").show();\n                } else {\n                    notify_err(Lang.get('constructor.menu.err_json_support'));\n                }\n                \n                $(\".dd-item\").removeClass(\"parentError\");\n                $(\".dd-item\").filter(function() {\n                    return $(this).find(\".dd-list\").length !== 0 && ($(this).attr(\"data-list-id\") != \"0\" || ($(this).attr(\"data-url\") && $(this).attr(\"data-url\") != \"javascript:;\"));\n                }).addClass(\"parentError\");\n            };\n            \n            this.root.find('.dd').nestable({\n                group: 1,\n                maxDepth: 5,\n                \n            }).on('change', updateOutput).nestable('collapseAll');\n            \n            var loadSiteMenu = function() {\n                var sel = self.root.find(\".dx-sites-cbo\");\n                if (sel.val() == self.site_id) {\n                    return false;\n                }\n                \n                if (self.nodes) {\n                    if (!validateChilds()) {\n                        sel.val(self.site_id);\n                        return false;\n                    }\n                \n                    saveData(loadSiteMenu);\n                }\n                \n                var url = self.options.root_url + self.options.builder_url + self.root.find(\".dx-sites-cbo\").val();\n                show_page_splash(1);\n                window.location.assign(encodeURI(url));\n            };\n            \n            $(window).on('beforeunload', function()\n            {\n                if($(\".dx-stick-footer\").hasClass('dx-page-in-edit-mode'))\n                {\n                    hide_page_splash(1);\n                    return 'Your changes have not been saved.';\n                }\n            });\n            \n            this.root.find(\".dx-sites-cbo\").change(loadSiteMenu);\n            \n            // adjust menu for vertical menu UI\n            if (!$(\"body\").hasClass(\"dx-horizontal-menu-ui\")) {\n                \n                var adjust_menu = function() {\n                    $(\".page-sidebar-menu\").css(\"padding-bottom\", '80px');\n                };\n                PageMain.addResizeCallback(adjust_menu);\n                \n                adjust_menu();\n                \n                $(\".dx-menu-builder-stick-title\").css(\"font-size\", \"14px\");\n                \n                var dv = $(\".dx-menu-sites\").find(\"div.col-sm-10\");\n                dv.css(\"margin-right\", \"-35px\");\n                dv.css(\"padding-left\", \"30px\");\n            }\n\t};\n})(jQuery);"]}