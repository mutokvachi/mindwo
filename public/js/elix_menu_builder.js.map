{"version":3,"sources":["menu_builder.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"elix_menu_builder.js","sourcesContent":["(function($)\r\n{\r\n\t/**\r\n\t * MenuBuilder - a jQuery plugin that renders menu drag & drop building UI\r\n\t *\r\n\t * @param root\r\n\t * @returns {*}\r\n\t * @constructor\r\n\t */\r\n\t$.fn.MenuBuilder = function(opts)\r\n\t{\r\n\t\tvar options = $.extend({}, $.fn.MenuBuilder.defaults, opts);\r\n\t\treturn this.each(function()\r\n\t\t{\r\n\t\t\tnew $.MenuBuilder(this, options);\r\n\t\t});\r\n\t};\r\n\t\r\n\t$.fn.MenuBuilder.defaults = {\r\n            root_url: getBaseUrl(),\r\n            builder_url: \"constructor/menu/\",\r\n            menu_list_id: 5\r\n\t};\r\n\t\r\n\t/**\r\n\t * MenuBuilder constructor\r\n\t *\r\n\t * @param root\r\n\t * @constructor\r\n\t */\r\n\t$.MenuBuilder = function(root, opts)\r\n\t{\r\n            $.data(root, 'MenuBuilder', this);\r\n            var self = this;\r\n            this.options = opts;\r\n            this.root = $(root);\r\n            this.nodes = null;\r\n            this.root_url = getBaseUrl();\r\n            this.site_id = self.root.find(\".dx-sites-cbo\").val();\r\n            this.itm_to_edit = null;\r\n            \r\n            var saveData = function(onsaved) {\r\n                show_page_splash();\r\n                var request = {\r\n                        site_id: self.site_id,\r\n                        items: self.nodes,\r\n                        _method: 'put'\r\n                };\r\n                \r\n                var save_url = self.options.root_url + self.options.builder_url + self.site_id;\r\n                \r\n                $.ajax({\r\n                        type: 'post',\r\n                        url: save_url,\r\n                        dataType: 'json',\r\n                        data: request,\r\n                        success: function(data)\r\n                        {\r\n                            self.nodes = null\r\n                            $(\".dx-stick-footer\").removeClass('dx-page-in-edit-mode');\r\n                            \r\n                            if (onsaved) {\r\n                                onsaved.call(this);\r\n                            }\r\n                            else {\r\n                                show_page_splash();\r\n                                notify_info(Lang.get('constructor.menu.msg_saved'));\r\n                                setTimeout(function(){ window.location.reload(true); }, 1000);\r\n                            }\r\n                        }\r\n                });  \r\n            };\r\n            \r\n            var validateChilds = function() {\r\n                if ($(\".dx-menu-builder\").find(\".parentError\").length !== 0) {\r\n                    notify_err(Lang.get('constructor.menu.err_parent'));\r\n                    $('html, body').animate({\r\n                        scrollTop: $(\".dx-menu-builder\").find(\".parentError:last\").offset().top - 66\r\n                    }, 2000);\r\n                    return false;\r\n                }\r\n                \r\n                return true;\r\n            };\r\n            \r\n            var editItemOpen = function () {\r\n                var itm = self.itm_to_edit;\r\n                show_page_splash();\r\n                open_form('form', itm.attr(\"data-id\"), self.options.menu_list_id, 0, 0, \"\", 0, \"\", {\r\n                    after_close: function(frm)\r\n                    {\r\n                        var new_parent_id = frm.find(\"[name=parent_id]\").val();\r\n                        var new_order = frm.find(\"[name=order_index]\").val();\r\n                        \r\n                        if (new_parent_id !== itm.attr(\"data-parent-id\") || new_order !== itm.attr(\"data-order-index\")) {\r\n                            show_page_splash();\r\n                            window.location.reload();\r\n                            return;\r\n                        }\r\n                        \r\n                        var new_title = frm.find(\"[name=title]\").val();\r\n                        var new_icon = frm.find(\"[name=fa_icon]\").val();\r\n                        \r\n                        if (itm.attr(\"data-title\") !== new_title) {\r\n                            itm.attr(\"data-title\", new_title);                            \r\n                            itm.find(\".dx-title:first\").text(new_title);\r\n                        }\r\n                        \r\n                        if (itm.attr(\"data-icon\") !== new_icon) {\r\n                            itm.find(\".dx-icon:first\").removeClass().addClass(new_icon).addClass(\"dx-icon\");\r\n                            itm.attr(\"data-icon\", new_icon);\r\n                        } \r\n                        \r\n                        var new_color = frm.find(\"[name=color]\").val();\r\n                        if (itm.attr(\"data-color\") !== new_color) {\r\n                            itm.find(\".dx-icon:first\").css(\"color\", new_color);\r\n                            itm.find(\".dx-title:first\").css(\"color\", new_color);\r\n                            itm.attr(\"data-color\", new_color);\r\n                        }\r\n                        self.itm_to_edit = null;\r\n                    }\r\n                });\r\n            }\r\n            \r\n            var newItemOpen = function() {\r\n                open_form('form', 0, self.options.menu_list_id, 0, 0, \"\", 1, \"\", {\r\n                    after_close: function(frm)\r\n                    {\r\n                        var new_id = parseInt(frm.find(\"[name=item_id]\").val());\r\n                       if (new_id > 0 ) {\r\n                            show_page_splash();\r\n                            window.location.reload();\r\n                        }\r\n                    }\r\n                });\r\n            };\r\n            \r\n            var undo_changes = function() {\r\n                show_page_splash();\r\n                $(\".dx-stick-footer\").removeClass('dx-page-in-edit-mode');\r\n                window.location.reload();\r\n            };\r\n            \r\n            this.root.find(\".dx-undo-btn\").click(function() {\r\n                PageMain.showConfirm(undo_changes, null, Lang.get('constructor.menu.confirm_title'), Lang.get('constructor.menu.confirm_msg'), Lang.get('constructor.menu.confirm_yes'), Lang.get('constructor.menu.confirm_no'), null);\r\n            });\r\n            \r\n            this.root.find(\".dx-new-btn\").click(function() {\r\n                if (self.nodes) {\r\n                    if (!validateChilds()) {                        \r\n                        return false;\r\n                    }\r\n                \r\n                    saveData(newItemOpen);\r\n                    return;\r\n                }\r\n                \r\n                newItemOpen();\r\n            });\r\n            \r\n            this.root.find(\".dx-edit-menu-link\").click(function() {\r\n                self.itm_to_edit = $(this).closest(\".dd-item\");\r\n                \r\n                if (self.nodes) {\r\n                    if (!validateChilds()) {\r\n                        self.itm_to_edit = null;\r\n                        return false;\r\n                    }\r\n                \r\n                    saveData(editItemOpen);\r\n                    return;\r\n                }\r\n                \r\n                editItemOpen();\r\n            });\r\n            \r\n            this.root.find(\".dx-save-btn\").click(function() {\r\n                if (!self.nodes) {\r\n                    notify_err(Lang.get('constructor.menu.err_no_changes'));\r\n                    return false;\r\n                }\r\n                \r\n                if (!validateChilds()) {\r\n                    return false;\r\n                }\r\n                saveData();\r\n            });\r\n            \r\n            var updateOutput = function (e) {\r\n                var list = e.length ? e : $(e.target);\r\n                if (window.JSON) {\r\n                    self.nodes = window.JSON.stringify(list.nestable('serialize'));                    \r\n                    $('.dx-stick-footer').addClass('dx-page-in-edit-mode');\r\n                    self.root.find(\".dx-undo-btn\").show();\r\n                } else {\r\n                    notify_err(Lang.get('constructor.menu.err_json_support'));\r\n                }\r\n                \r\n                $(\".dd-item\").removeClass(\"parentError\");\r\n                $(\".dd-item\").filter(function() {\r\n                    return $(this).find(\".dd-list\").length !== 0 && ($(this).attr(\"data-list-id\") != \"0\" || ($(this).attr(\"data-url\") && $(this).attr(\"data-url\") != \"javascript:;\"));\r\n                }).addClass(\"parentError\");\r\n            };\r\n            \r\n            this.root.find('.dd').nestable({\r\n                group: 1,\r\n                maxDepth: 5,\r\n                \r\n            }).on('change', updateOutput).nestable('collapseAll');\r\n            \r\n            var loadSiteMenu = function() {\r\n                var sel = self.root.find(\".dx-sites-cbo\");\r\n                if (sel.val() == self.site_id) {\r\n                    return false;\r\n                }\r\n                \r\n                if (self.nodes) {\r\n                    if (!validateChilds()) {\r\n                        sel.val(self.site_id);\r\n                        return false;\r\n                    }\r\n                \r\n                    saveData(loadSiteMenu);\r\n                }\r\n                \r\n                var url = self.options.root_url + self.options.builder_url + self.root.find(\".dx-sites-cbo\").val();\r\n                show_page_splash(1);\r\n                window.location.assign(encodeURI(url));\r\n            };\r\n            \r\n            $(window).on('beforeunload', function()\r\n            {\r\n                if($(\".dx-stick-footer\").hasClass('dx-page-in-edit-mode'))\r\n                {\r\n                    hide_page_splash(1);\r\n                    return 'Your changes have not been saved.';\r\n                }\r\n            });\r\n            \r\n            this.root.find(\".dx-sites-cbo\").change(loadSiteMenu);\r\n\t};\r\n})(jQuery);"]}